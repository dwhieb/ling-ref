{{!-- NB: The use of multi-line comments avoids extra whitespace in the HTML, while retaining readability for the programmer. --}}

{{!-- an individual person (author, editor), with appropriate punctuation depending on position in the list of authors/editors --}}
{{#*inline "person"}}{{!--
  if this is the first person in the list
  --}}{{#if @first}}{{last_name}}{{#if first_name}}, {{first_name}}{{/if}}{{!--
  if this is this last person in the list
  --}}{{else if @last}} &amp; {{first_name}} {{last_name}}{{!--
  if this is neither the first nor last person in the list
  --}}{{else}}, {{#if first_name}}{{first_name}}{{/if}} {{last_name}}{{/if}}{{!--
--}}{{/inline}}

{{!-- author list --}}
{{#*inline "authors"}}{{#each authors}}{{> person}}{{/each}}{{/inline}}

{{!-- edition --}}
{{#*inline "edition"}}
  {{#is edition '1'}}
    1<sup>st</sup>
  {{else is edition '2'}}
    2<sup>nd</sup>
  {{else is edition '3'}}
    3<sup>rd</sup>
  {{else}}
    {{edition}}<sup>th</sup>
  {{/is}}
{{/inline}}

{{!-- editor list --}}
{{#*inline "editors"}}
  {{#each editors}}

    {{!-- add an ampersand before the last name --}}
    {{#if @last}}
      {{#unless @first}}&amp;{{/unless}}
    {{/if}}

    {{!-- name --}}
    {{!-- use reversed names for first editor if no authors are present --}}
    {{#if ../authors}}{{!--
      --}}{{#if first_name}}{{first_name}} {{/if}}{{last_name}}{{!--
    --}}{{else}}{{!--
      --}}{{#if @first}}{{!--
        --}}{{last_name}}{{#if first_name}}, {{first_name}}{{/if}}{{!--
      --}}{{else}}{{!--
        --}}{{#if first_name}}{{first_name}} {{/if}}{{last_name}}{{!--
      --}}{{/if}}{{!--
    --}}{{/if}}{{!--

    add a comma after each name
    --}}{{#unless @last}},{{/unless}}

    {{!-- add the (ed(s).) after the list of names --}}
    {{#if @last}}
      {{#if @first}}(ed.){{else}}(eds.){{/if}}{{!--
    --}}{{/if}}{{!--

  --}}{{/each}}{{!--
--}}{{/inline}}

{{!-- pages --}}
{{#*inline "pages"}}{{#replace '-' 'â€“'}}{{pages}}{{/replace}}{{/inline}}

{{!-- publisher info --}}
{{#*inline "publisherInfo"}}{{!--
  --}}{{#if publisher}}{{publisher}}{{!--
  --}}{{else if institution}}{{institution}}{{!--
  --}}{{/if}}{{!--
--}}{{/inline}}

{{!-- series info --}}
{{#*inline "seriesInfo"}}{{#if series}} ({{series}}{{#if volume}} {{volume}}{{else if revision}} {{revision}}{{/if}}){{/if}}{{/inline}}

{{!-- the <p> element that contains the complete reference --}}
<details data-key="{{citation_key}}" class=ref>

  {{!-- citation --}}
  <summary class=citation>
    {{#replace '(\.){2}' '.'}}{{!-- Removes any sequence of two periods in a row --}}

      {{#is type "book"}}
        {{#if authors}}{{> authors}}{{else if editors}}{{> editors}}{{else}}unknown{{/if}}.
        {{year}}.
        <cite>{{title}}</cite>{{#if edition}}, {{> edition}} ed.{{/if}}{{> seriesInfo}}.
        {{> publisherInfo}}.
      {{/is}}

      {{#is type "book_section"}}
        {{> authors}}.
        {{year}}.
        {{title}}. In {{#if editors}}{{> editors}}{{/if}}, <cite>{{source}}</cite>{{!--
        --}}{{#if edition}}, {{> edition}} ed.{{/if}}{{> seriesInfo}}.
        {{> publisherInfo}}.
      {{/is}}

      {{#is type "conference_proceedings"}}
        {{> authors}}.
        {{year}}.
        {{title}}. {{#if editors}}In {{> editors}}, {{else}}Presented at {{/if}}<cite>{{source}}</cite>{{> seriesInfo}}.{{!--
        --}}{{#if publisher}}{{> publisherInfo}}.{{/if}}
      {{/is}}

      {{#is type "encyclopedia_article"}}
        {{> authors}}.
        {{year}}.
        {{title}}. In {{#if editors}}{{> editors}}{{/if}}, <cite>{{source}}</cite>{{> seriesInfo}}.
        {{> publisherInfo}}.
      {{/is}}

      {{#is type "generic"}}

        {{#if authors}}{{> authors}}{{else if editors}}{{> editors}}{{else}}unknown{{/if}}.
        {{year}}.

        {{#unless source}}<cite>{{/unless}}{{title}}{{#unless source}}</cite>{{/unless}}{{!--
        --}}{{#if source}}. In <cite>{{source}}</cite>{{/if}}{{> seriesInfo}}.

        {{#if source_type}}{{source_type}}.{{/if}}
        {{#if user_context}}{{user_context}}.{{/if}}
        {{> publisherInfo}}.

      {{/is}}

      {{#is type "magazine_article"}}
        {{> authors}}.
        {{year}}.
        {{title}}.
        <cite>{{source}}</cite> {{volume}}{{#if issue}}({{issue}}){{/if}}: {{> pages}}.
      {{/is}}

      {{#is type "journal"}}
        {{> authors}}.
        {{year}}.
        {{title}}.
        <cite>{{source}}</cite> {{volume}}{{#if issue}}({{issue}}){{/if}}: {{> pages}}.
      {{/is}}

      {{#is type "thesis"}}
        {{> authors}}.
        {{year}}.
        <cite>{{title}}</cite>.
        {{#if source_type}}{{source_type}}.{{/if}}
        {{#if user_context}}{{user_context}}.{{/if}}
        {{#if department}}{{department}}, {{/if}}{{institution}}.
      {{/is}}

      {{#if identifiers.doi}}
        DOI: <a href='https://doi.org/{{identifiers.doi}}'>{{identifiers.doi}}</a>.
      {{/if}}

      {{#is type "web_page"}}
        {{> authors}}.
        {{year}}.
        {{title}}.
        {{#if editors}}In {{> editors}},{{/if}}
        <cite>{{source}}</cite>.
        {{#if websites}}Accessible at: <a href="{{websites.[0]}}">{{websites.[0]}}</a>.{{/if}}
      {{/is}}

    {{/replace}}{{!-- End replacement for double periods --}}

    {{#is type "web_page"}}
    {{else}}
      {{#if websites}}(<a href="{{websites.[0]}}">link</a>){{/if}}
    {{/is}}

  </summary>

  {{!-- abstract --}}
  {{#if abstract}}
    <section class=abstract>
      <h4>Abstract</h4>
      <div>{{md abstract}}</div>
    </section>
  {{/if}}

  {{!-- notes --}}
  {{#if notes}}
    <section class=notes>
      <h4>Notes</h4>
      <div>{{md notes}}</div>
    </section>
  {{/if}}

</details>
