{{!-- NB: The use of multi-line comments avoids extra whitespace in the HTML, while retaining readability for the programmer. --}}

{{!-- an individual person (author, editor), with appropriate punctuation depending on position in the list of authors/editors --}}
{{#*inline "person"}}{{!--
  if this is the first person in the list
  --}}{{#if @first}}{{last_name}}{{#if first_name}}, {{first_name}}{{/if}}{{!--
  if this is this last person in the list
  --}}{{else if @last}} &amp; {{first_name}} {{last_name}}{{!--
  if this is neither the first nor last person in the list
  --}}{{else}}, {{#if first_name}}{{first_name}}{{/if}} {{last_name}}{{/if}}{{!--
--}}{{/inline}}

{{!-- author list --}}
{{#*inline "authors"}}{{#each authors}}{{> person}}{{/each}}{{/inline}}

{{!-- year --}}
{{#*inline "year"}}{{#if year}}{{year}}{{else}}n.d.{{/if}}{{/inline}}

{{!-- edition --}}
{{#*inline "edition"}}
  {{#lr-is edition '1'}}
    1<sup>st</sup>
  {{else lr-is edition '2'}}
    2<sup>nd</sup>
  {{else lr-is edition '3'}}
    3<sup>rd</sup>
  {{else}}
    {{edition}}<sup>th</sup>
  {{/lr-is}}
{{/inline}}

{{!-- editor list --}}
{{#*inline "editors"}}
  {{#each editors}}

    {{!-- add an ampersand before the last name --}}
    {{#if @last}}
      {{#unless @first}}&amp;{{/unless}}
    {{/if}}

    {{!-- name --}}
    {{!-- use reversed names for first editor if no authors are present --}}
    {{#if ../authors}}{{!--
      --}}{{#if first_name}}{{first_name}} {{/if}}{{last_name}}{{!--
    --}}{{else}}{{!--
      --}}{{#if @first}}{{!--
        --}}{{last_name}}{{#if first_name}}, {{first_name}}{{/if}}{{!--
      --}}{{else}}{{!--
        --}}{{#if first_name}}{{first_name}} {{/if}}{{last_name}}{{!--
      --}}{{/if}}{{!--
    --}}{{/if}}{{!--

    add a comma after each name
    --}}{{#unless @last}},{{/unless}}

    {{!-- add the (ed(s).) after the list of names --}}
    {{#if @last}}
      {{#if @first}}(ed.){{else}}(eds.){{/if}}{{!--
    --}}{{/if}}{{!--

  --}}{{/each}}{{!--
--}}{{/inline}}

{{!-- pages --}}
{{#*inline "pages"}}{{#lr-replace '-' 'â€“'}}{{pages}}{{/lr-replace}}{{/inline}}

{{!-- publisher info --}}
{{#*inline "publisherInfo"}}{{!--
  --}}{{#if publisher}}{{publisher}}.{{!--
  --}}{{else if institution}}{{institution}}.{{!--
  --}}{{/if}}{{!--
--}}{{/inline}}

{{!-- series info --}}
{{#*inline "seriesInfo"}}{{#if series}} ({{series}}{{#if volume}} {{volume}}{{else if revision}} {{revision}}{{/if}}){{/if}}{{/inline}}

{{!-- the wrapper element that contains the complete reference --}}
<{{#if details}}details{{else}}section{{/if}} data-key="{{citation_key}}" class=ref>

  {{!-- citation --}}
  <{{#if details}}summary{{else}}section{{/if}} class=citation>
    {{#lr-replace '(\.){2}' '.'}}{{!-- Removes any sequence of two periods in a row --}}

      {{#lr-is type "book"}}
        {{#if authors}}{{> authors}}{{else if editors}}{{> editors}}{{else}}unknown{{/if}}.
        {{> year}}.
        <cite>{{lr-md title 'inline'}}</cite>{{#if edition}}, {{> edition}} ed.{{/if}}{{> seriesInfo}}.
        {{> publisherInfo}}
      {{/lr-is}}

      {{#lr-is type "book_section"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}. In {{#if editors}}{{> editors}}{{/if}}, <cite>{{source}}</cite>{{!--
        --}}{{#if edition}}, {{> edition}} ed.{{/if}}{{> seriesInfo}}.
        {{> publisherInfo}}
      {{/lr-is}}

      {{#lr-is type "conference_proceedings"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}.
        <cite>{{source}}</cite>{{> seriesInfo}}{{!--
          --}}{{#if month}}, {{lr-month month}}{{#if day}} {{day}}{{/if}}{{/if}}{{!--
          --}}{{#if institution}}, {{institution}}{{/if}}{{!--
          --}}{{#if city}}, {{city}}{{/if}}.
      {{/lr-is}}

      {{#lr-is type "encyclopedia_article"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}. In {{#if editors}}{{> editors}}{{/if}}, <cite>{{source}}</cite>{{> seriesInfo}}.
        {{> publisherInfo}}
      {{/lr-is}}

      {{#lr-is type "generic"}}

        {{#if authors}}{{> authors}}{{else if editors}}{{> editors}}{{else}}unknown{{/if}}.
        {{> year}}.

        {{#unless source}}<cite>{{/unless}}{{lr-md title 'inline'}}{{#unless source}}</cite>{{/unless}}{{!--
        --}}{{#if source}}. In <cite>{{source}}</cite>{{/if}}{{> seriesInfo}}.

        {{#if source_type}}{{source_type}}.{{/if}}
        {{#if user_context}}{{user_context}}.{{/if}}

      {{/lr-is}}

      {{#lr-is type "magazine_article"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}.
        <cite>{{source}}</cite> {{volume}}{{#if issue}}({{issue}}){{/if}}: {{> pages}}.
      {{/lr-is}}

      {{#lr-is type "journal"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}.
        {{#if editors}}In {{> editors}}, {{/if}}<cite>{{source}}</cite> {{volume}}{{#if issue}}({{issue}}){{/if}}: {{> pages}}.
      {{/lr-is}}

      {{#lr-is type "thesis"}}
        {{> authors}}.
        {{> year}}.
        <cite>{{lr-md title 'inline'}}</cite>.
        {{#if source_type}}{{source_type}}.{{/if}}
        {{#if user_context}}{{user_context}}.{{/if}}
        {{#if department}}{{department}}, {{/if}}{{institution}}.
      {{/lr-is}}

      {{#if identifiers.doi}}
        DOI: <a href='https://doi.org/{{identifiers.doi}}'>{{identifiers.doi}}</a>.
      {{/if}}

      {{#lr-is type "web_page"}}
        {{> authors}}.
        {{> year}}.
        {{lr-md title 'inline'}}.
        {{#if editors}}In {{> editors}},{{/if}}
        <cite>{{source}}</cite>.
        {{#if websites}}Accessible at: <a href="{{websites.[0]}}">{{websites.[0]}}</a>.{{/if}}
      {{/lr-is}}

    {{/lr-replace}}{{!-- End replacement for double periods --}}

    {{#lr-is type "web_page"}}
    {{else}}
      {{#if websites}}(<a href="{{websites.[0]}}">link</a>){{/if}}
    {{/lr-is}}

  </{{#if details}}summary{{else}}section{{/if}}>

  {{!-- abstract --}}
  {{#if abstract}}
    <section class=abstract>
      <h4>Abstract</h4>
      <div>{{lr-md abstract}}</div>
    </section>
  {{/if}}

  {{!-- notes --}}
  {{#if notes}}
    <section class=notes>
      <h4>Notes</h4>
      <div>{{lr-md notes}}</div>
    </section>
  {{/if}}

</{{#if details}}details{{else}}section{{/if}}>
